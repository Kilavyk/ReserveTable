<!-- templates/users/profile.html -->
{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - Gourmet Haven</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
{% include 'includes/header.html' %}

<main class="container my-5">
    <div class="row content-box">
        <!-- Левая часть - информация о пользователе -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center p-4">
                    <!-- Аватар пользователя -->
                    <div class="position-relative d-inline-block mb-3">
                        <img id="avatar-preview"
                             src="{% if user.photo %}{{ user.photo.url }}?{% now 'U' %}{% else %}{% static 'img/default-avatar.png' %}{% endif %}"
                             alt="Фотография пользователя"
                             class="rounded-circle shadow"
                             style="width: 120px; height: 120px; object-fit: cover;"
                             onerror="this.src='{% static 'img/default-avatar.png' %}'">
                    </div>

                    <!-- Имя email номер телефона-->
                    <h4 class="card-title mb-1">{{ user.get_full_name|default:"Имя не указано" }}</h4>
                    <p class="text-muted mb-0">{{ user.email }}</p>
                    <p class="text-muted mb-3">{{ user.phone_number }}</p>

                    <!-- Кнопка редактирования -->
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#editProfileModal">
                        <i class="bi bi-pencil"></i> Редактировать профиль
                    </button>
                </div>
            </div>

            <!-- Статистика -->
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header bg-white border-0 pb-0">
                    <h5 class="card-title mb-0">Статистика</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>Всего броней</span>
                            <span>{{ bookings_count }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая часть - история бронирований -->
        <div class="col-lg-8">
            <!-- Заголовок с кнопкой -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">История бронирований</h4>
                        <a href="{% url 'bookings:booking_view' %}" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus-circle"></i> Новое бронирование
                        </a>
                    </div>
                </div>
            </div>

            <!-- Список бронирований -->
            <div class="shadow-sm border-0">
                <div class="card-body">
                    {% if bookings %}
                    <div class="row g-3">
                        {% for booking in bookings %}
                        <!-- Карточка бронирования -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body">
                                    <!-- Заголовок с номером столика и статусом -->
                                    <div class="d-flex align-items-center mb-3">
                                        <h5 class="card-title mb-0 me-3">Столик №{{ booking.table.number }}</h5>
                                        <span class="badge
                                        {% if booking.status == 'confirmed' %}bg-success
                                        {% elif booking.status == 'pending' %}bg-warning
                                        {% else %}bg-danger{% endif %}">
                                        {{ booking.get_status_display }}
                                        </span>
                                    </div>

                                    <!-- Основная информация о бронировании -->
                                    <div class="mb-2">
                                        <i class="bi bi-calendar-event me-2"></i>
                                        <strong>Зарезервирован на {{ booking.booking_date }} в
                                            {{ booking.get_time_slot_display }} для {{ booking.guests_count }}
                                            гостей</strong>
                                    </div>

                                    <!-- Примечания -->
                                    {% if booking.special_requests %}
                                    <div class="mb-2">
                                        <i class="bi bi-chat-text me-2"></i>
                                        <strong>Примечания:</strong> {{ booking.special_requests }}
                                    </div>
                                    {% endif %}

                                    <!-- Дата создания брони -->
                                    <div class="text-muted mb-3">
                                        <i class="bi bi-clock me-1"></i>
                                        <small>Бронь зарегистрирована: {{ booking.created_at|date:"d.m.Y H:i" }}</small>
                                    </div>

                                    <!-- Кнопки действий -->
                                    <div class="d-flex gap-2">
                                        <!-- Кнопка Изменить - только для неподтвержденных, неотмененных и непрошедших бронирований -->
                                        {% if booking.status == 'pending' and not booking.is_past %}
                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                data-bs-toggle="modal" data-bs-target="#editBookingModal{{ booking.id }}">
                                            <i class="bi bi-pencil"></i> Изменить
                                        </button>
                                        {% endif %}

                                        <!-- Кнопка Отменить - только для непрошедших бронирований -->
                                        {% if not booking.is_past and booking.status != 'cancelled' %}
                                        <form method="post" action="{% url 'bookings:cancel_booking' booking.id %}"
                                              class="d-inline" onsubmit="return confirmCancelBooking()">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger btn-sm">
                                                <i class="bi bi-x-circle"></i> Отменить
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Модальное окно редактирования для каждого бронирования -->
                        <div class="modal fade" id="editBookingModal{{ booking.id }}" tabindex="-1"
                             aria-labelledby="editBookingModalLabel{{ booking.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-md">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editBookingModalLabel{{ booking.id }}">
                                            Изменение бронирования столика №{{ booking.table.number }}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form method="post" action="{% url 'bookings:edit_booking' booking.id %}">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <!-- Блок для отображения ошибок редактирования -->
                                            <div id="edit-booking-errors-{{ booking.id }}">
                                                {% for message in messages %}
                                                    {% if 'booking_edit_'|add:booking.id|stringformat:'i' in message.tags %}
                                                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                                        {{ message }}
                                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                                    </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>

                                            <!-- Дата бронирования -->
                                            <div class="mb-3">
                                                <label for="booking_date{{ booking.id }}" class="form-label">Дата бронирования</label>
                                                <input type="date" class="form-control" id="booking_date{{ booking.id }}"
                                                       name="booking_date" value="{{ booking.booking_date|date:'Y-m-d' }}"
                                                       min="{% now 'Y-m-d' %}" required>
                                            </div>

                                            <!-- Временной слот -->
                                            <div class="mb-3">
                                                <label for="time_slot{{ booking.id }}" class="form-label">Время</label>
                                                <select class="form-select" id="time_slot{{ booking.id }}" name="time_slot" required>
                                                    <option value="">Выберите время</option>
                                                    {% for slot_value, slot_display in time_slots %}
                                                    <option value="{{ slot_value|time:'H:i' }}"
                                                            {% if booking.time_slot|time:'H:i' == slot_value|time:'H:i' %}selected{% endif %}>
                                                        {{ slot_display }}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                            </div>

                                            <!-- Количество гостей -->
                                            <div class="mb-3">
                                                <label for="guests_count{{ booking.id }}" class="form-label">Количество гостей</label>
                                                <input type="number" class="form-control" id="guests_count{{ booking.id }}"
                                                       name="guests_count" value="{{ booking.guests_count }}" min="1" max="20" required>
                                            </div>

                                            <!-- Особые пожелания -->
                                            <div class="mb-3">
                                                <label for="special_requests{{ booking.id }}" class="form-label">Особые пожелания</label>
                                                <textarea class="form-control" id="special_requests{{ booking.id }}"
                                                          name="special_requests" rows="3"
                                                          placeholder="Укажите ваши пожелания...">{{ booking.special_requests|default:'' }}</textarea>
                                            </div>

                                            <!-- Скрытое поле с ID столика -->
                                            <input type="hidden" name="table_id" value="{{ booking.table.id }}">
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                                            <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Пагинация -->
                    {% if bookings.has_other_pages %}
                    <nav aria-label="Навигация по страницам" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if bookings.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ bookings.previous_page_number }}" aria-label="Предыдущая">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&laquo;</span>
                            </li>
                            {% endif %}

                            {% for i in bookings.paginator.page_range %}
                                {% if bookings.number == i %}
                                <li class="page-item active">
                                    <span class="page-link">{{ i }}</span>
                                </li>
                                {% else %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if bookings.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ bookings.next_page_number }}" aria-label="Следующая">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&raquo;</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="card text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-calendar-x display-1 text-muted"></i>
                        </div>
                        <h4 class="text-muted mb-3">У вас еще нет бронирований</h4>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Модальное окно редактирования профиля -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Редактирование профиля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Блок для отображения сообщений -->
                {% for message in messages %}
                {% if 'profile' in message.tags or 'success' in message.tags %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show"
                     role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                {% endfor %}

                <form method="post" action="{% url 'users:profile_edit' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Текущая аватарка -->
                    <div class="text-center mb-4">
                        <img id="modal-avatar-preview"
                             src="{% if user.photo %}{{ user.photo.url }}?{% now 'U' %}{% else %}{% static 'img/default-avatar.png' %}{% endif %}"
                             alt="Текущая аватарка"
                             class="rounded-circle shadow mb-3"
                             style="width: 100px; height: 100px; object-fit: cover;"
                             onerror="this.src='{% static 'img/default-avatar.png' %}'">

                        {% if user.photo %}
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmDeletePhoto()">
                                <i class="bi bi-trash"></i> Удалить фото
                            </button>
                        </div>
                        {% else %}
                        <p class="text-muted small">Фотография не установлена</p>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">Имя</label>
                            <input type="text"
                                   class="form-control"
                                   id="first_name"
                                   name="first_name"
                                   value="{{ user.first_name|default:'' }}"
                                   placeholder="Введите ваше имя">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Фамилия</label>
                            <input type="text"
                                   class="form-control"
                                   id="last_name"
                                   name="last_name"
                                   value="{{ user.last_name|default:'' }}"
                                   placeholder="Введите вашу фамилию">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="phone_number" class="form-label">Номер телефона</label>
                        <input type="tel"
                               class="form-control"
                               id="phone_number"
                               name="phone_number"
                               value="{{ user.phone_number|default:'' }}"
                               placeholder="+7 (XXX) XXX-XX-XX">
                        <div class="form-text">Номер телефона для связи с вами.</div>
                    </div>

                    <div class="mb-3">
                        <label for="photo" class="form-label">Новая фотография</label>
                        <input type="file"
                               class="form-control"
                               id="photo"
                               name="photo"
                               accept="image/*">
                        <div class="form-text">Выберите новую фотографию для профиля (JPG, PNG, max 5MB)</div>
                    </div>

                    <!-- Скрытое поле для удаления фото -->
                    <input type="hidden" id="delete_photo" name="delete_photo" value="false">

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Сохранить изменения
                        </button>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Отмена
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% include 'includes/footer.html' %}

<script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>

<script>
    // Функция подтверждения отмены бронирования
    function confirmCancelBooking() {
        return confirm('Вы уверены, что хотите отменить это бронирование?');
    }

    // Автоматическое открытие модального окна редактирования брони при ошибках
    document.addEventListener('DOMContentLoaded', function() {
        {% for message in messages %}
            {% if 'booking_edit_' in message.tags %}
                // Извлекаем ID бронирования из тега сообщения
                var bookingId = '{{ message.tags|slice:"13:" }}';
                if (bookingId) {
                    var modalId = 'editBookingModal' + bookingId;
                    var editBookingModal = new bootstrap.Modal(document.getElementById(modalId));
                    editBookingModal.show();
                }
            {% endif %}
        {% endfor %}
    });

    // Автоматическое обновление минимальной даты в формах редактирования
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            input.setAttribute('min', today);
        });
    });

    // Автоматическое открытие модального окна редактирования профиля при ошибках
    document.addEventListener('DOMContentLoaded', function() {
        {% for message in messages %}
            {% if 'profile' in message.tags %}
                var editProfileModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
                editProfileModal.show();
            {% endif %}
        {% endfor %}
    });

    // Предпросмотр выбранной фотографии
    document.getElementById('photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Валидация файла
            if (!file.type.match('image.*')) {
                alert('Пожалуйста, выберите изображение (JPG, PNG)');
                this.value = '';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Файл слишком большой (максимум 5MB)');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // Обновляем отображение аватарки в модальном окне
                const modalAvatar = document.getElementById('modal-avatar-preview');
                modalAvatar.src = e.target.result;

                // Обновляем отображение аватарки в основном профиле
                const mainAvatar = document.getElementById('avatar-preview');
                mainAvatar.src = e.target.result;

                // Сбрасываем флаг удаления фото, если выбрана новая
                document.getElementById('delete_photo').value = 'false';

                // Скрываем кнопку удаления если она была показана
                const deleteButton = document.querySelector('.delete-photo-btn');
                if (deleteButton) {
                    deleteButton.style.display = 'none';
                }
            }
            reader.readAsDataURL(file);
        }
    });

    // Подтверждение удаления фото
    function confirmDeletePhoto() {
        if (confirm('Вы уверены, что хотите удалить фотографию профиля?')) {
            // Устанавливаем флаг удаления
            document.getElementById('delete_photo').value = 'true';

            // Устанавливаем стандартную аватарку для предпросмотра
            const modalAvatar = document.getElementById('modal-avatar-preview');
            const mainAvatar = document.getElementById('avatar-preview');
            modalAvatar.src = '{% static "img/default-avatar.png" %}';
            mainAvatar.src = '{% static "img/default-avatar.png" %}';

            // Сбрасываем поле выбора файла
            document.getElementById('photo').value = '';

            // Скрываем кнопку удаления
            const deleteButton = document.querySelector('.delete-photo-btn');
            if (deleteButton) {
                deleteButton.style.display = 'none';
            }
        }
    }
</script>
</body>
</html>